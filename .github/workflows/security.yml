name: Security & Dependencies

on:
  schedule:
    - cron: '0 0 * * 0'  # Weekly on Sunday
  push:
    branches: [ main, develop ]
    paths:
      - 'backend/requirements.txt'
      - 'frontend-control-room/package.json'

jobs:
  # Dependency vulnerability scanning
  dependencies:
    runs-on: ubuntu-latest
    name: Check Dependencies
    
    steps:
      - uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.12'

      - name: Install Safety
        run: |
          python -m pip install --upgrade pip
          pip install safety

      - name: Check Python dependencies
        continue-on-error: true
        run: |
          safety check --file backend/requirements.txt --json > safety-report.json || true
          cat safety-report.json

      - name: Set up Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'

      - name: Check NPM dependencies
        continue-on-error: true
        run: |
          cd frontend-control-room
          npm install
          npm audit --json > npm-audit.json || true
          cat npm-audit.json

  # SAST - Static Application Security Testing
  sast:
    runs-on: ubuntu-latest
    name: Static Security Analysis
    
    steps:
      - uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.12'

      - name: Install SAST tools
        run: |
          python -m pip install --upgrade pip
          pip install bandit[toml] semgrep safety

      - name: Run Bandit
        continue-on-error: true
        run: |
          bandit -r backend/app -f json -o bandit-report.json
          bandit -r backend/app

      - name: Run Semgrep
        continue-on-error: true
        run: |
          pip install semgrep
          semgrep --config=p/owasp-top-ten backend/app --json -o semgrep-report.json || true
          semgrep --config=p/owasp-top-ten backend/app

  # DAST - Dynamic Application Security Testing
  dast:
    runs-on: ubuntu-latest
    name: Dynamic Security Testing
    needs: [dependencies, sast]
    if: github.event_name == 'push'
    
    services:
      postgres:
        image: postgres:15-alpine
        env:
          POSTGRES_USER: testuser
          POSTGRES_PASSWORD: testpass
          POSTGRES_DB: testdb
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

      redis:
        image: redis:7-alpine
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 6379:6379

    steps:
      - uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.12'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r backend/requirements.txt
          pip install pytest pytest-asyncio

      - name: Start application
        env:
          DATABASE_MODE: postgres
          DATABASE_URL: postgresql://testuser:testpass@localhost:5432/testdb
          REDIS_URL: redis://localhost:6379/0
          SECRET_KEY: test-secret-key-for-testing-only-32chars!
        run: |
          cd backend
          python -m uvicorn app.main:app --host 0.0.0.0 --port 8000 &
          sleep 5

      - name: Run OWASP ZAP scan
        uses: zaproxy/action-baseline@v0.7.0
        with:
          target: 'http://localhost:8000'
          rules_file_name: '.zap/rules.tsv'
          cmd_options: '-a'
        continue-on-error: true

  # Container image scanning
  image-scan:
    runs-on: ubuntu-latest
    name: Scan Container Images
    
    steps:
      - uses: actions/checkout@v3

      - name: Run Trivy on Dockerfile
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'config'
          scan-ref: 'backend/Dockerfile'
          format: 'sarif'
          output: 'trivy-config.sarif'

      - name: Upload Trivy config results
        uses: github/codeql-action/upload-sarif@v2
        with:
          sarif_file: 'trivy-config.sarif'
        continue-on-error: true

  # License compliance check
  license-check:
    runs-on: ubuntu-latest
    name: Check License Compliance
    
    steps:
      - uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.12'

      - name: Install pip-licenses
        run: |
          python -m pip install --upgrade pip
          pip install pip-licenses

      - name: Check Python licenses
        continue-on-error: true
        run: |
          pip install -r backend/requirements.txt
          pip-licenses --format=json --output-file=backend-licenses.json
          pip-licenses

      - name: Set up Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'

      - name: Check NPM licenses
        continue-on-error: true
        run: |
          cd frontend-control-room
          npm install
          npx license-report --package=./package.json --json > npm-licenses.json || true
          npx license-report --package=./package.json || true

  # Code quality metrics
  quality-metrics:
    runs-on: ubuntu-latest
    name: Quality Metrics
    
    steps:
      - uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.12'

      - name: Install quality tools
        run: |
          python -m pip install --upgrade pip
          pip install radon pylint

      - name: Calculate Python complexity
        continue-on-error: true
        run: |
          echo "=== Cyclomatic Complexity ===" 
          radon cc backend/app -a
          echo "=== Maintainability Index ===" 
          radon mi backend/app

      - name: Run pylint for detailed metrics
        continue-on-error: true
        run: |
          pip install -r backend/requirements.txt
          pylint backend/app --output-format=json > pylint-report.json || true
